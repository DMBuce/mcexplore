#!/bin/bash
# update the version and docs every commit
#
# updates the docs and sets version in mcexplore.py to 2.$numcommits.g$prev+1,
# where $prev = the commit before the current version
#
# to find the commit(s) corresponding to $prev+1:
#
#    git rev-list --children --all | awk '/^$prev/ {print substr($2,1,7)}'
#
# or, check the Releases page on github and ctrl+f

# update version
updatever() {
	local version="2.$(( $(git rev-list --count HEAD)+1 )).g$(git rev-parse --short HEAD)+1"
	echo "Updating version to $version"
	sed -i "/version =/ s/=.*/= f'{prog} $version'/" mcexplore.py
}

# check if we're committing a change to mcexplore.py
if git diff --name-only --cached | grep -q -xF mcexplore.py; then
	# check if mcexplore.py has no unstaged changes
	if ! git status --porcelain | grep -q '^.M mcexplore.py'; then
		# update version and add mcexplore.py to commit
		updatever
		echo "Adding mcexplore.py to commit"
		git add mcexplore.py
	# update the version and check if it changed
	elif updatever; git diff mcexplore.py | grep -q -e '^[+-] *version ='; then
		# prompt user to add the updated version to the commit
		echo "Please add the version change with \`git add -p mcexplore.py\` before committing."
		exit 1
	fi
fi

# update man page
make doc
git add mcexplore.1

